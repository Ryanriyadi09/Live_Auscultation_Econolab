<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Live Auscultation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button {
      padding: 10px 16px;
      margin-right: 10px;
      margin-top: 10px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #004aad;
    }
    #timer {
      margin-top: 5px;
      font-weight: bold;
      color: #0a7c00;
    }
  </style>
</head>

<body>

  <h2>Live Auscultation (WebRTC)</h2>

  <button id="start">NAKES START</button>
  <button id="join">DOCTOR JOIN</button>

  <div id="status">Status: Idle</div>
  <div id="timer">Duration: 00:00:00</div>

  <audio id="audio" autoplay></audio>

  <!-- ========================= -->
  <!-- FIREBASE + WEBRTC SCRIPT -->
  <!-- ========================= -->
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc,
      onSnapshot, collection, addDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================
    // FIREBASE CONFIG
    // ==========================
    const firebaseConfig = {
      apiKey: "ISI_API_KEY_ANDA",
      authDomain: "econolab-live-auscultation.firebaseapp.com",
      projectId: "econolab-live-auscultation",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==========================
    // ROOM
    // ==========================
    const roomId = "LAB-001";
    const roomRef = doc(db, "rooms", roomId);

    // ==========================
    // UI
    // ==========================
    const statusDiv = document.getElementById("status");
    const timerDiv = document.getElementById("timer");
    const audio = document.getElementById("audio");

    let pc = null;
    let timerInterval = null;
    let connectedAt = null;

    // ==========================
    // WEBRTC CONFIG
    // ==========================
    const rtcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    // ==========================
    // FORMAT DURATION
    // ==========================
    function formatDuration(ms) {
      const total = Math.floor(ms / 1000);
      const h = String(Math.floor(total / 3600)).padStart(2, "0");
      const m = String(Math.floor((total % 3600) / 60)).padStart(2, "0");
      const s = String(total % 60).padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    // ==========================
    // START (NAKES)
    // ==========================
    document.getElementById("start").onclick = async () => {
      statusDiv.innerText = "Status: Waiting for doctor...";

      pc = new RTCPeerConnection(rtcConfig);

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      pc.onicecandidate = e => {
        if (e.candidate) {
          addDoc(collection(roomRef, "candidates"), e.candidate.toJSON());
        }
      };

      pc.onconnectionstatechange = async () => {
        if (pc.connectionState === "connected") {
          statusDiv.innerText = "Status: Connection successful ✅";

          await setDoc(roomRef, {
            connected: true,
            connectedAt: Date.now()
          }, { merge: true });
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await setDoc(roomRef, {
        offer,
        doctorJoined: false,
        connected: false
      });
    };

    // ==========================
    // JOIN (DOKTER)
    // ==========================
    document.getElementById("join").onclick = async () => {
      pc = new RTCPeerConnection(rtcConfig);

      pc.ontrack = e => {
        audio.srcObject = e.streams[0];
      };

      pc.onicecandidate = e => {
        if (e.candidate) {
          addDoc(collection(roomRef, "candidates"), e.candidate.toJSON());
        }
      };

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === "connected") {
          statusDiv.innerText = "Status: Connection successful ✅";
        }
      };

      const snap = await getDoc(roomRef);
      if (!snap.exists()) {
        alert("Room belum dibuat oleh nakes");
        return;
      }

      await pc.setRemoteDescription(snap.data().offer);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await setDoc(roomRef, {
        answer,
        doctorJoined: true
      }, { merge: true });
    };

    // ==========================
    // ROOM LISTENER
    // ==========================
    onSnapshot(roomRef, snap => {
      const data = snap.data();
      if (!data) return;

      if (data.doctorJoined && !data.connected) {
        statusDiv.innerText = "Status: Doctor joined, connecting...";
      }

      if (data.connected && data.connectedAt) {
        connectedAt = data.connectedAt;

        if (!timerInterval) {
          timerInterval = setInterval(() => {
            timerDiv.innerText =
              "Duration: " + formatDuration(Date.now() - connectedAt);
          }, 1000);
        }
      }

      if (data.answer && pc && !pc.currentRemoteDescription) {
        pc.setRemoteDescription(data.answer);
      }
    });

    // ==========================
    // ICE CANDIDATES
    // ==========================
    onSnapshot(collection(roomRef, "candidates"), snap => {
      snap.docChanges().forEach(c => {
        if (c.type === "added" && pc) {
          pc.addIceCandidate(c.doc.data());
        }
      });
    });

  </script>

</body>
</html>
